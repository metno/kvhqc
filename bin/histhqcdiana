#!/bin/bash
set -x

export HQCDIR=/usr/local
export KVALOBS=$HQCDIR
export KVDIR=/usr/local/lib/kvalobs

export DIANADIR=/usr/local
export HIST=1

$DIANADIR/bin/diana.bin -s ${HQCDIR}/etc/kvhqc/diana.setup& > ~/diana.err 2>/dev/null

debugger="gdb"
ulimit -c 100000000000

home=$HOME/.hqc
test -d $home || mkdir $home
test -d $home/work  || mkdir $home/work
cd $home

rm core* 1>/dev/null 2>&1
test -s dbxresult  && mv -f dbxresult dbxresult.old
test -s mail.core  && mv -f mail.core mail.core.old

# remove old lpr print files, left after failure...
find . -name "prt_????-??-??_??:??:??.ps" -mtime +1 -exec rm {} \;

tstart=`date`

$HQCDIR/bin/hqc.bin $@

tstop=`date`

corefound="no"
for corefile in core*
do
    test -f $corefile || continue
    test -s $corefile || continue
    corefound="yes"
done

if [ $corefound = "yes" ] ; then
echo "USER $USER"     >mail.core
echo "-------------" >>mail.core
uname -a             >>mail.core
echo "-------------" >>mail.core
echo "START $tstart" >>mail.core
echo "STOP  $tstop"  >>mail.core

echo "HQC:"              >>mail.core 
echo "-------------" >>mail.core
pwd                  >>mail.core
ls -ltr core*        >>mail.core

for corefile in core*
do

test -f $corefile || continue
test -s $corefile || continue

#make gdb input:
/bin/echo -e 'bt\nq\n' > /tmp/gdb.cmd.$$

$debugger -batch -x /tmp/gdb.cmd.$$ $HQCDIR/bin/hqc.bin $corefile 1>dbxresult 2>&1 

rm -f /tmp/gdb.cmd.$$

echo "===============================================" >>mail.core
cat dbxresult        >>mail.core

rm $corefile
done

echo "===============================================" >>mail.core

adr="knut.johansen@met.no vegard.bones@met.no"
Mail -s "HQC CRASH" $adr < mail.core

fi

exit

